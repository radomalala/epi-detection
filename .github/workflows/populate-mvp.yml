# Workflow to populate the repository with the full MVP scaffold.
# Uses the built-in GITHUB_TOKEN to push changes back to the same repo.
# Put this file in .github/workflows/populate-mvp.yml and execute manually (Actions -> Populate scaffold -> Run workflow).
name: Populate scaffold (manual)

on:
  workflow_dispatch:

# Allow writing repository contents (required to push)
permissions:
  contents: write

jobs:
  populate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # keep the default credentials (GITHUB_TOKEN) available

      - name: Setup Git user
        run: |
          git config user.name "repo-bot"
          git config user.email "repo-bot@example.com"

      - name: Create scaffold files
        run: |
          set -e

          # Root files
          cat > README.md <<'EOF'
Detection EPI — MVP

Résumé
- MVP pour détection et gestion des non-conformités EPI (casque/gilet).
- Composants inclus : backend Node.js (Express), frontend React (Vite), Postgres (métadonnées), MinIO (stockage S3-compatible), Docker Compose pour dev.

Prérequis
- Docker & docker-compose
- Node.js v18+ (pour dev local)

Quickstart (dev)
1. Copier .env.example → .env et adapter les valeurs.
2. Lancer infra + services :
   docker-compose up --build
3. Backend : http://localhost:4000
4. Frontend : http://localhost:3000
EOF

          cat > .env.example <<'EOF'
# Database
DATABASE_URL=postgres://epi:epi_pass@db:5432/epidb

# S3 / MinIO
S3_ENDPOINT=http://minio:9000
S3_BUCKET=epimedia
S3_ACCESS_KEY=minioadmin
S3_SECRET_KEY=minioadmin
S3_FORCE_PATH_STYLE=true

# App
PORT=4000
JWT_SECRET=change_me

# Frontend
VITE_API_URL=http://localhost:4000/api
EOF

          cat > docker-compose.yml <<'EOF'
version: "3.8"
services:
  db:
    image: postgres:15
    environment:
      POSTGRES_USER: epi
      POSTGRES_PASSWORD: epi_pass
      POSTGRES_DB: epidb
    volumes:
      - db-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  minio:
    image: minio/minio:latest
    command: server /data
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    ports:
      - "9000:9000"

  backend:
    build: ./backend
    env_file: .env
    depends_on:
      - db
      - minio
    ports:
      - "4000:4000"
    volumes:
      - ./backend:/usr/src/app
    command: sh -c "npm run dev"

  frontend:
    build: ./frontend
    env_file: .env
    ports:
      - "3000:5173"
    volumes:
      - ./frontend:/usr/src/app
    command: sh -c "npm run dev"

volumes:
  db-data:
  minio-data:
EOF

          # create other scaffold files (backend, frontend, CI, schema)...
          mkdir -p backend/src/routes backend/src/models backend/src/services backend/sql
          cat > backend/Dockerfile <<'EOF'
FROM node:18-alpine
WORKDIR /usr/src/app
COPY package*.json ./
RUN npm ci
COPY . .
EXPOSE 4000
CMD ["npm", "run", "start"]
EOF

          cat > backend/package.json <<'EOF'
{
  "name": "epi-backend",
  "version": "0.1.0",
  "main": "src/index.js",
  "scripts": {
    "start": "node src/index.js",
    "dev": "nodemon --watch src --ext js --exec node src/index.js",
    "lint": "eslint .",
    "test": "echo \"no tests yet\" && exit 0"
  },
  "dependencies": {
    "aws-sdk": "^2.1360.0",
    "body-parser": "^1.20.2",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "express": "^4.18.2",
    "pg": "^8.11.0",
    "socket.io": "^4.7.2",
    "uuid": "^9.0.0",
    "multer": "^1.4.5-lts.1"
  },
  "devDependencies": {
    "nodemon": "^2.0.22",
    "eslint": "^8.44.0"
  }
}
EOF

          cat > backend/src/index.js <<'EOF'
const express = require('express');
const http = require('http');
const { Server } = require('socket.io');
const bodyParser = require('body-parser');
const cors = require('cors');
require('dotenv').config();

const camerasRouter = require('./routes/cameras');
const incidentsRouter = require('./routes/incidents');

const app = express();
app.use(cors());
app.use(bodyParser.json());

app.use('/api/cameras', camerasRouter);
app.use('/api/incidents', incidentsRouter);

app.get('/api/health', (req, res) => res.json({ ok: true }));

const port = process.env.PORT || 4000;
const server = http.createServer(app);
const io = new Server(server, { cors: { origin: '*' } });

io.on('connection', (socket) => {
  console.log('socket connected', socket.id);
});

app.set('io', io);

server.listen(port, () => {
  console.log(`Backend listening on ${port}`);
});
EOF

          # minimal frontend
          mkdir -p frontend/src
          cat > frontend/package.json <<'EOF'
{
  "name": "epi-frontend",
  "version": "0.1.0",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "start": "vite preview"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "socket.io-client": "^4.7.2"
  },
  "devDependencies": {
    "vite": "^5.2.0"
  }
}
EOF

          cat > frontend/index.html <<'EOF'
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Detection EPI - Dashboard</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
EOF

          cat > frontend/src/main.jsx <<'EOF'
import React from 'react';
import { createRoot } from 'react-dom/client';
import App from './App';

createRoot(document.getElementById('root')).render(<App />);
EOF

          cat > frontend/src/App.jsx <<'EOF'
import React, { useEffect, useState } from 'react';
import { io } from 'socket.io-client';

const API = import.meta.env.VITE_API_URL || 'http://localhost:4000/api';
const socket = io('http://localhost:4000');

export default function App() {
  const [incidents, setIncidents] = useState([]);

  useEffect(() => {
    fetch(`${API}/incidents`)
      .then(r => r.json())
      .then(setIncidents)
      .catch(console.error);

    socket.on('incident', (data) => {
      setIncidents(prev => [data, ...prev]);
    });

    return () => socket.disconnect();
  }, []);

  return (
    <div style={{ padding: 20, fontFamily: 'Arial' }}>
      <h1>Dashboard Detection EPI (MVP)</h1>
      <section>
        <h2>Incidents récents</h2>
        {incidents.length === 0 && <p>Aucun incident</p>}
        <ul>
          {incidents.slice(0, 50).map((it) => (
            <li key={it.id}>
              <strong>{it.type}</strong> — cam:{it.camera_id} — conf:{(it.confidence||0).toFixed(2)}
            </li>
          ))}
        </ul>
      </section>
    </div>
  );
}
EOF

          # .gitignore
          cat > .gitignore <<'EOF'
node_modules/
.env
dist/
.vscode/
.DS_Store
EOF

          git add -A
          git commit -m "Add initial scaffold (generated by workflow)" || echo "no changes to commit"

      - name: Push changes to main using GITHUB_TOKEN
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          # Use the built-in token to authenticate the push
          git remote set-url origin https://x-access-token:${REPO_TOKEN}@github.com/${{ github.repository }}.git
          git push origin HEAD:main --force

      - name: Success message
        run: |
          echo "Scaffold pushed to main"
